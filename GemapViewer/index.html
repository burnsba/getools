<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="js/svg-pan-zoom.js"></script>

    <link href="css/nouislider.css?v=1570" rel="stylesheet">
    <script src="js/nouislider.js"></script>

    <link href="css/draggable-resizable-dialog.css" rel="stylesheet">
    <script src="js/draggable-resizable-dialog.js"></script>

    <style>
        @font-face {
            font-family: "ibmvga9x16";
            src: url("font/Web437_IBM_VGA_9x16.woff") format('woff');
        }

        .s-row {
            margin-bottom: 6px;
        }

        @media screen and (max-width: 800px) {
            .s-row {
                margin-bottom: 12px;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: ibmvga9x16;
            font-size: 16px;
            overscroll-behavior: none;
        }

        .ul {
            text-decoration: underline;
        }

        .big, .big > * {
            font-size: 32px;
        }

        input[type="button"] {
            padding-left: 4px;
            padding-right: 4px;
            padding-top: 2px;
            padding-bottom: 2px;
        }

        #status-bar {
            background-color: #eeeeee;
            overflow: hidden;
            min-height: 48px;
            height: 48px;
            max-height: 48px;
            padding-left: 24px;
        }

        #mode-controls {
            position: absolute;
            right: 40px;
            bottom: 30px;
            display: flex;
            align-items: center;
            flex-direction: column;
        }

        .mode-control-panel {
            display: flex;
            align-items: center;
            flex-direction: column;
        }

        .float-control-row {
            margin: 8px;
            display: flex;
        }

        .ann-state-disable {
            opacity: 0.5;
        }

        .m8 {
            margin: 8px;
        }

        .vstack {
            display: flex;
            flex-direction: column;
        }

        .ctl-button {
            font-size: 32px;
            padding: 6px;
        }

        .col-left-sep {
            margin-top: 10px;
            margin-bottom: 10px;
            display: block;
            border-bottom: 4px solid #8790d8;
            width: 90%;
            margin-left: auto;
            margin-right: auto;
        }

        .vert-space-10 {
            margin-top: 10px;
            display: block;
        }

        .vert-space-12 {
            margin-top: 12px;
            display: block;
        }

        .vert-space-24 {
            margin-top: 24px;
            display: block;
        }

        .vert-space-120 {
            margin-top: 120px;
            display: block;
        }

        .h-space-16 {
            display: inline-block;
            min-width: 16px;
            max-width: 16px;
            margin: 0;
            padding: 0;
        }

        #slider-container {
            margin-left: 24px;
            margin-right: 48px;
            margin-top: 12px;
            margin-bottom: 12px;
        }

        #map-container {
            flex-grow: 1;
            height: calc(100vh - 54px);
            position: relative;
        }

        #mmap {
            height: calc(100vh - 54px);
            position: fixed;
        }

        #level-select {
            width: 100%;
        }

        #column-left-head {
            z-index: 10;
        }

        #column-left-body {
            z-index: 9;
        }

        #column-left-head, #column-left-body {
            position: fixed;
            width: 300px;
            max-width: 300px;
            min-width: 300px;
            padding: 4px;
            background-color: #eaf9ff;
        }

        #column-left-head {
            height: 152px;
            overflow: hidden;
        }

        #column-left-body {
            top: 152px;
            /* viewheight, head, status bar, padding */
            height: calc(100vh - 152px - 48px - 8px);
            overflow-y: scroll;
        }

        .dialog-ai-command {
            margin-bottom: 6px;
            border: 1px solid #cccccc;
            padding: 4px;
        }

        .dialog-ai-command.ai-label {
            background-color: #d7ffd7;
        }

        .dialog-content-seperator {
            display: block;
            min-height: 2px;
            border-bottom: 1px solid #cccccc;
            width: 100%;
            margin-top: 8px;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>

    <script>

        const svgns = "http://www.w3.org/2000/svg";

        const g_MinZoomToPan = 8.0;

        let g_UseMode = 0;

        const UseMode = Object.freeze({
            Disable: Symbol("disable"),
            Move: Symbol("move"),
            Ruler: Symbol("ruler"),
            Annotate: Symbol("annotate"),
        });

        /**
         * 0: not started.
         * 
         * guard aim limit
         * 10: started, ghost circle to place point
         * 11: origin placed, ghost line to place aim limit
         * 
         * circle
         * 20: started, ghost circle to place point
         * 21: origin placed, ghost line to set radius
         * 
         * noise
         * 30: started, ghost circle to place point
         * 
         * erase
         * 99
         */
        let g_AnnotateState = 0;

        let g_AnnotatePrevClick = { x: 0, y: 0 };

        /**
        * 0: not started
        * 1: started, no previous point
        * 2: started, at least one point
        */
        let g_RulerDropMode = 0;
        let g_LastRulerDropMode = 0;
        // ruler point
        let g_PreviousPoint = { "x": 0, "y": 0 };
        // ruler
        let g_TotalDistance = 0;
        let g_PxToMeterFactor = 3;

        // ruler dot
        // half width + entire border width
        const g_DotRadius = 22;
        const g_DotDiameter = g_DotRadius * 2;

        const g_RulerLineDash = "40,20";
        const g_RulerLineThickness = "18px"; // including unit suffix

        var g_StageLevelScale = 1.0;
        var g_InvStageLevelScale = 1.0;

        var g_StageBounds = {
            "natural": {
                "min": {
                    "x": 0.0,
                    "y": 0.0,
                    "z": 0.0
                },
                "max": {
                    "x": 0.0,
                    "y": 0.0,
                    "z": 0.0
                }
            },
            "scaled": {
                "min": {
                    "x": 0.0,
                    "y": 0.0,
                    "z": 0.0
                },
                "max": {
                    "x": 0.0,
                    "y": 0.0,
                    "z": 0.0
                }
            }
        };

        var g_ZoomerLoaded = false;

        var g_SvgStyleSheet = null;
        var g_SvgStyleRuleIndexLookup = {};
        var g_SvgStyleCurrentValues = {
            /* default/starting values */
            '.gelib-stan': {
                'stroke': '#9e87a3',
                'stroke-width': 1,
                'fill': '#fdf5ff'
            },
            '.gelib-stan:hover': {
                'stroke': '#9e87a3',
                'stroke-width': 4,
                'fill': '#fdf5ff'
            },
            '.gelib-room': {
                'stroke': 'blue',
                'stroke-width': 2,
                'fill': '#ffffff',
                'fill-opacity': 0
            },
            '.gelib-room:hover': {
                'stroke': 'blue',
                'stroke-width': 6,
                'fill': '#ffffff'
            },
            '.gelib-pad': {
                'stroke': '#9c009e',
                'stroke-width': 2,
                'fill': '#ff00ff'
            },
            '.gelib-pad:hover': {
                'stroke': '#ec60ee',
                'stroke-width': 4,
                'fill': '#ff99ff'
            },
            '.gelib-wpline': {
                'stroke': '#ff80ff',
                'stroke-width': 12
            },
            '.gelib-wpline:hover': {
                'stroke': '#a831a8',
                'stroke-width': 18
            },
            '.gelib-patrol': {
                'stroke': '#3fb049',
                'stroke-width': 18
            },
            '.gelib-patrol:hover': {
                'stroke': '#94e34f',
                'stroke-width': 24
            }
        };

        let g_DialogBox = null;
        var g_AllowDialog = true;
        var g_SelectedItem = null;

        var g_SliderInit = false;

        function DialogCheckSimpleMode() {
            g_AllowDialog = false;
            SvgUnselectItems();
            HideDialog();
            document.getElementById('ui-panel-simple-mode-check').checked = true;
        }

        function UiPanelToggleSimpleMode(node) {
            if (node.checked) {
                g_AllowDialog = false;
                SvgUnselectItems();
                HideDialog();
            } else {
                g_AllowDialog = true;
            }
        }

        function HideDialog() {
            document.getElementById('dialog').style.display = 'none';
        }

        function ApplyStyleChange(node) {
            if (!g_ZoomerLoaded || !node) {
                return;
            }

            let selector = node.dataset.selector;
            let property = node.dataset.prop;
            let css_type = node.dataset.cssType;

            if (!selector || !property || !css_type) {
                return;
            }

            if (!g_SvgStyleSheet || !g_SvgStyleCurrentValues[selector]) {
                return;
            }

            let svg_style_index = g_SvgStyleRuleIndexLookup[selector];

            if (!isFinite(svg_style_index)) {
                return;
            }

            let prop_value = null;

            if (css_type === 'number') {
                prop_value = parseFloat(node.value);
            } else if (css_type === 'color') {
                // match 6 or 3 digit html hex, with optional '#' prefix
                let rem = ('' + node.value).match(/^#?[0-9a-fA-F]{6}$|^#?[0-9a-fA-F]{3}$/);
                if (!rem) {
                    return;
                }
                prop_value = rem[0];
            } else {
                return;
            }

            let rules = g_SvgStyleSheet.cssRules || g_SvgStyleSheet.rules;
            rules[svg_style_index].style[property] = prop_value;

            g_SvgStyleCurrentValues[selector][property] = prop_value;
        }

        function SetInitialControlValues() {
            let style_node = document.getElementById('style-panel');
            let inputs = style_node.getElementsByTagName('input');
            for (const node of inputs) {
                let selector = node.dataset.selector;
                if (!selector) {
                    continue;
                }
                let style_values = g_SvgStyleCurrentValues[selector];
                if (!style_values) {
                    continue;
                }
                let property = node.dataset.prop;
                node.value = style_values[property];
            }
        }

        function ChangeLevel() {
            const node = document.getElementById('level-select');
            if (!node) {
                return;
            }
            const options = node.options;
            if (!options) {
                return;
            }
            const selectedOption = options[options.selectedIndex];
            if (!selectedOption) {
                return;
            }
            let filename = selectedOption.dataset['filename'];

            if (!filename) {
                return;
            }

            document.getElementById('mmap').setAttribute("data", filename);
        }

        function ToggleLayer(node) {
            let svg_layer_id = "";

            switch (node.name) {
                case "check-bg-layer": svg_layer_id = "svg-bg-room-layer"; break;
                case "check-stan-layer": svg_layer_id = "svg-stan-tile-layer"; break;
                case "check-setup-pad-layer": svg_layer_id = "svg-pad-layer"; break;
                case "check-setup-waypoint-layer": svg_layer_id = "svg-waypoint-layer"; break;
                case "check-setup-patrol-layer": svg_layer_id = "svg-patrol-layer"; break;
                case "check-setup-alarm-layer": svg_layer_id = "svg-setup-alarm-layer"; break;
                case "check-setup-ammo-layer": svg_layer_id = "svg-setup-ammo-layer"; break;
                case "check-setup-aircraft-layer": svg_layer_id = "svg-setup-aircraft-layer"; break;
                case "check-setup-bodyarmor-layer": svg_layer_id = "svg-setup-bodyarmor-layer"; break;
                case "check-setup-chr-layer": svg_layer_id = "svg-setup-chr-layer"; break;
                case "check-setup-cctv-layer": svg_layer_id = "svg-setup-cctv-layer"; break;
                case "check-setup-collectable-layer": svg_layer_id = "svg-setup-collectable-layer"; break;
                case "check-setup-door-layer": svg_layer_id = "svg-setup-door-layer"; break;
                case "check-setup-drone-layer": svg_layer_id = "svg-setup-drone-layer"; break;
                case "check-setup-key-layer": svg_layer_id = "svg-setup-key-layer"; break;
                case "check-setup-safe-layer": svg_layer_id = "svg-setup-safe-layer"; break;
                case "check-setup-singlemonitor-layer": svg_layer_id = "svg-setup-singlemonitor-layer"; break;
                case "check-setup-prop-layer": svg_layer_id = "svg-setup-prop-layer"; break;
                case "check-setup-tank-layer": svg_layer_id = "svg-setup-tank-layer"; break;
                case "check-setup-intro-layer": svg_layer_id = "svg-setup-intro-layer"; break;

                    break;
            }

            if (!svg_layer_id) {
                return;
            }

            var svg_doc = document.getElementById('mmap').contentDocument;
            if (!svg_doc) {
                return;
            }

            var svg_node = svg_doc.getElementById(svg_layer_id);
            if (!svg_node) {
                return;
            }

            if (!node.checked) {
                svg_node.style.display = 'none';
            } else {
                svg_node.style.display = '';
            }
        }

        function UpdateControlPanel() {
            svgPanZoom(document.getElementById('mmap'), {
                maxZoom: 100
            });

            g_ZoomerLoaded = true;

            SvgUnselectItems();
            ResetAndHideDialog();
            UpdateStageBounds();
            RebuildSlider();
            InjectDocumentStyle();
            BuildPropList();
            BuildPatrolList();
            BuildAiScriptsList();
            InjectEventHandlers();
            ApplyLayerFilter();

            // loading the svg object un-applies the css width, manually reapply that here.
            FixMapDisplayStuff();

            SetSvgPoint();
        }

        function ResetAndHideDialog() {
            if (!g_DialogBox) {
                return;
            }

            HideDialog();
            DialogSetTitlebar("...");
            DialogClearSelected();
            DialogClearAi();
        }

        var g_SvgPoint = null;

        function SetSvgPoint() {
            let svg = GetSvg();
            if (!svg) {
                return;
            }

            g_SvgPoint = svg.createSVGPoint();
        }

        function HideUiControls() {
            document.getElementById('column-left-body').style.display = 'none';
            document.getElementById('btn-hide-ui').style.display = 'none';
            document.getElementById('btn-show-ui').style.display = '';
            FixMapDisplayStuff(true);
        }

        function ShowUiControls() {
            document.getElementById('column-left-body').style.display = '';
            document.getElementById('btn-hide-ui').style.display = '';
            document.getElementById('btn-show-ui').style.display = 'none';
            FixMapDisplayStuff();
        }

        function FixMapDisplayStuff(v) {
            if (v) {
                document.getElementById('mmap').style.width = 'calc(100vw - 4px)';
                document.getElementById('mmap').style.left = 0;
            } else {
                document.getElementById('mmap').style.width = 'calc(100vw - 4px - 300px)';
                document.getElementById('mmap').style.left = '300px';
            }
        }

        function ApplyLayerFilter() {
            let unchecked = document.getElementById('control-layers-panel').querySelectorAll('input:not(:checked)');
            for (const node of unchecked) {
                ToggleLayer(node);
            }
        }

        function InjectDocumentStyle() {
            let xml = document.getElementById('mmap').contentDocument;
            if (!xml) {
                return null;
            }

            let svg = xml.getElementsByTagName('svg');
            if (!svg || svg.length != 1) {
                return null;
            }

            svg = svg[0];

            var style = xml.createElementNS("http://www.w3.org/2000/svg", 'style');
            svg.appendChild(style);
            style.type = 'text/css';

            g_SvgStyleSheet = style.sheet;

            style.sheet.insertRule('.vertical-bound-filter { display: none; }', style.sheet.cssRules.length);
            style.sheet.insertRule('#fake-marker { position: absolute; opacity: 0.5; pointer-events: none; }', style.sheet.cssRules.length);
            style.sheet.insertRule('#fake-line { min-width: 120px; position: absolute; opacity: 0.5; pointer-events: none; }', style.sheet.cssRules.length);
            style.sheet.insertRule('.line { min-height: 0px; border-bottom: 6px dashed #000000; transform-origin: 0px 3px; }', style.sheet.cssRules.length);
            style.sheet.insertRule('.dot { background-color: #00ffc3; border: 2px solid #4580ff; border-radius: 50 %; }', style.sheet.cssRules.length);
            // style the selected item, including a transition effect when first selected.
            style.sheet.insertRule('#svg-setup-chr-layer .svg-logical-item.selected, #svg-pad-layer .svg-logical-item.selected {' +
                    'outline: 14px solid rgba(255,0,0,0.5); ' +
                    'outline-offset: 30px; ' +
                    'outline-style: dashed; ' +
                    'transition-property: outline-offset; ' +
                    'transition-duration: 0.5s; ' +
                    'transition-timing-function: linear; ' +
                    ' } ', style.sheet.cssRules.length);
            // style secondary selected item, including a transition effect when first selected.
            style.sheet.insertRule('#svg-setup-chr-layer .svg-logical-item.secondary, #svg-pad-layer .svg-logical-item.secondary {' +
                    'outline: 14px solid rgba(0,220,225,0.7); ' +
                    'outline-offset: 30px; ' +
                    'outline-style: dashed; ' +
                    'transition-property: outline-offset; ' +
                    'transition-duration: 0.5s; ' +
                    'transition-timing-function: linear; ' +
                    ' } ', style.sheet.cssRules.length);

            let index = 0;
            let rule = '';
            // replace the svg css styles with the values from the javascript css container.
            for (const selector of Object.entries(g_SvgStyleCurrentValues).map(key => key[0])) {
                rule = Array.prototype.join.call(Object.entries(g_SvgStyleCurrentValues[selector]).map(kvp => `${kvp[0]}: ${kvp[1]};`), ' ');
                let rule_text = selector + ' { ' + rule + ' }';
                index = style.sheet.insertRule(rule_text, style.sheet.cssRules.length);
                // save reference to allow user updating
                g_SvgStyleRuleIndexLookup[selector] = index;
            }
        }

        function InjectEventHandlers() {
            let svg = GetSvg();
            if (!svg) {
                return;
            }

            svg.addEventListener('mousemove', MapMouseEvent);
            svg.addEventListener('mousemove', HandleRulerMouseMove);
            svg.addEventListener('click', HandleSvgClick);
            svg.addEventListener('touchstart', HandleSvgClick);
        }

        function UpdateStageBounds() {
            let svg = GetSvg();
            if (!svg) {
                return;
            }

            g_StageBounds.natural.min.x = parseFloat(svg.dataset.nMinX);
            g_StageBounds.natural.max.x = parseFloat(svg.dataset.nMaxX);
            g_StageBounds.natural.min.y = parseFloat(svg.dataset.nMinY);
            g_StageBounds.natural.max.y = parseFloat(svg.dataset.nMaxY);
            g_StageBounds.natural.min.z = parseFloat(svg.dataset.nMinZ);
            g_StageBounds.natural.max.z = parseFloat(svg.dataset.nMaxZ);

            g_StageBounds.scaled.min.x = parseFloat(svg.dataset.sMinX);
            g_StageBounds.scaled.max.x = parseFloat(svg.dataset.sMaxX);
            g_StageBounds.scaled.min.y = parseFloat(svg.dataset.sMinY);
            g_StageBounds.scaled.max.y = parseFloat(svg.dataset.sMaxY);
            g_StageBounds.scaled.min.z = parseFloat(svg.dataset.sMinZ);
            g_StageBounds.scaled.max.z = parseFloat(svg.dataset.sMaxZ);

            g_StageLevelScale = parseFloat(svg.dataset.levelScale);
            g_InvStageLevelScale = 1.0 / g_StageLevelScale;

            document.getElementById('map-min-y').innerHTML = g_StageBounds.scaled.min.y;
            document.getElementById('map-max-y').innerHTML = g_StageBounds.scaled.max.y;

            // console.log('new bounds: g_StageScaledMinY=' + g_StageBounds.scaled.min.y + ', g_StageScaledMaxY=' + g_StageBounds.scaled.max.y);
        }

        // iterate svg, extract unique prop ids, create UI checkbox input to allow disabling.
        function BuildPropList() {
            let svg = GetSvg();
            if (!svg) {
                return;
            }

            let prop_names = [... new Set(Array.from(svg.querySelectorAll('[data-prop-name]')).map(x => x.dataset.propName))];
            let container = document.getElementById('show-hide-prop-inputs');

            container.innerHTML = '';

            for (const name of prop_names) {
                let div = document.createElement('div');
                div.classList.add("s-row");

                let label = document.createElement('label');
                let input = document.createElement('input');

                label.innerText = name;

                input.setAttribute('type', 'checkbox');
                input.dataset.propName = name;
                input.addEventListener('change', ToggleDisableProp);

                label.appendChild(input);
                div.appendChild(label);

                container.appendChild(div);
            }
        }

        // iterate svg, extract unique prop ids, create UI checkbox input to allow disabling.
        function BuildPatrolList() {

            let svg = GetSvg();
            if (!svg) {
                return;
            }

            let patrolContainerNodes = [... new Set(Array.from(svg.querySelectorAll('.gelib-patrol')).map(x => x.closest('.svg-logical-item')))];
            let container = document.getElementById('show-hide-patrol-inputs');

            container.innerHTML = '';

            for (const node of patrolContainerNodes) {
                let div = document.createElement('div');
                div.classList.add("s-row");

                let label = document.createElement('label');
                let input = document.createElement('input');

                let rem = node.id.match(/^svg-patrol-([0-9]+)$/);
                if (!rem || rem.length < 2) {
                    continue;
                }
                label.innerText = `patrol ${rem[1]}`;

                input.setAttribute('type', 'checkbox');
                input.dataset.patrolNodeId = node.id;
                node.dataset.patrolNodeId = rem[1];
                input.addEventListener('change', ToggleDisablePatrol);

                label.appendChild(input);
                div.appendChild(label);

                container.appendChild(div);
            }
        }

        function BuildAiScriptsList() {
            let svg = GetSvg();
            if (!svg) {
                return;
            }

            let aiNodes = [... new Set(Array.from(svg.querySelectorAll('#svg-ailists > g')))];
            let container = document.getElementById('list-ai-scripts');

            container.innerHTML = '';

            for (const node of aiNodes) {
                let div = document.createElement('div');
                div.classList.add("s-row");

                let input = document.createElement('input');

                let rem = node.id.match(/^svg-ai-([0-9]+)$/);
                if (!rem || rem.length < 2) {
                    continue;
                }
                let id = parseInt(rem[1]);
                input.value = `ai 0x${id.toString(16)}`;

                input.setAttribute('type', 'button');

                input.addEventListener('click', HandleAiListClick);
                input.dataset.aiId = id;
                input.dataset.aiNodeId = node.id;

                div.appendChild(input);

                container.appendChild(div);
            }
        }

        function ToggleDisableProp(e) {
            if (!e) {
                return;
            }
            let node = e.target;
            if (!node) {
                return;
            }

            let xml = document.getElementById('mmap').contentDocument;
            if (!xml) {
                return;
            }

            let prop_name = node.dataset.propName;
            let display_value = '';
            if (node.checked) {
                display_value = 'none';
            }

            Array.from(xml.querySelectorAll('[data-prop-name="' + prop_name + '"]')).forEach(x => x.style.display = display_value);
        }

        function ToggleDisablePatrol(e) {
            if (!e) {
                return;
            }
            let node = e.target;
            if (!node) {
                return;
            }

            let xml = document.getElementById('mmap').contentDocument;
            if (!xml) {
                return;
            }

            let patrolNodeId = node.dataset.patrolNodeId;
            let display_value = '';
            if (node.checked) {
                display_value = 'none';
            }

            Array.from(xml.querySelectorAll('#' + patrolNodeId)).forEach(x => x.style.display = display_value);
        }

        function HideAllProps() {
            ToggleVisibilityAllProps('hide');
        }
        function ShowAllProps() {
            ToggleVisibilityAllProps('show');
        }
        function ToggleVisibilityAllProps(mode) {

            let svg = GetSvg();
            if (!svg) {
                return;
            }

            let display_value = '';
            let checkvalue = false;
            if (mode === 'hide') {
                display_value = 'none';
                checkvalue = true;
            } else if (mode === 'show') {
                // nothing to do
            } else {
                return;
            }

            // svg elements. Not all props are in the setup-prop-layer. [data-prop-name] is always .svg-logical-item
            Array.from(svg.querySelectorAll('[data-prop-name]')).forEach(x => x.style.display = display_value);
            // ui checkmark state
            Array.from(document.getElementById('show-hide-prop-inputs').querySelectorAll('input')).forEach(x => x.checked = checkvalue);
        }

        function HideAllPatrols() {
            ToggleVisibilityAllPatrols('hide');
        }
        function ShowAllPatrols() {
            ToggleVisibilityAllPatrols('show');
        }
        function ToggleVisibilityAllPatrols(mode) {

            let svg = GetSvg();
            if (!svg) {
                return;
            }

            let display_value = '';
            let checkvalue = false;
            if (mode === 'hide') {
                display_value = 'none';
                checkvalue = true;
            } else if (mode === 'show') {
                // nothing to do
            } else {
                return;
            }

            // svg elements
            Array.from(svg.querySelectorAll('#svg-patrol-layer .svg-logical-item')).forEach(x => x.style.display = display_value);
            // ui checkmark state
            Array.from(document.getElementById('show-hide-patrol-inputs').querySelectorAll('input')).forEach(x => x.checked = checkvalue);
        }

        function EnsureDialog() {
            if (!g_DialogBox) {
                var id = 'dialog';
                g_DialogBox = new DialogBox(id, DefaultDialogCallback);
            }
        }

        function DefaultDialogCallback(btnName) {
            //
        }

        function HandleAiListClick(e) {
            if (!g_AllowDialog) {
                return;
            }

            EnsureDialog();

            let aiId = parseInt(e.target.dataset.aiId);

            DialogLoadAiScriptContent(aiId);
            DialogSetTitlebar(`ai 0x${aiId.toString(16)}`);

            DialogClearSelected();

            g_DialogBox.showDialog();
        }

        function AiIdToSvgNodeId(aiId) {
            let id = parseInt(aiId);
            return `svg-ai-${id}`;
        }

        function DialogLoadAiScriptContent(aiId, prependTitleSeperator) {
            let svg = GetSvg();
            if (!svg) {
                return;
            }

            aiId = parseInt(aiId);

            EnsureDialog();

            let dialogContent = document.getElementById('dialog-ailist');
            dialogContent.innerHTML = '';

            if (prependTitleSeperator) {
                DialogAppendSeperator(dialogContent);

                let div = document.createElement('div');
                div.innerText = `ai script: 0x${aiId.toString(16)}`;
                dialogContent.appendChild(div);
            }

            let svgid = AiIdToSvgNodeId(aiId);

            let svgAiNode = svg.querySelectorAll('#' + svgid)[0];

            for (const node of svgAiNode.childNodes) {
                if (node.textContent.match(/^\s*$/)) {
                    continue;
                }

                let div = document.createElement('div');
                div.classList.add('dialog-ai-command');

                let divContent = document.createElement('div');
                divContent.innerText = node.textContent;
                div.appendChild(divContent);

                if (node.textContent.match(/^...: \[0x02\]/)) {
                    div.classList.add('ai-label');
                }

                if (node.dataset.xPadId) {
                    let id = parseInt(node.dataset.xPadId);

                    let panToNode = document.createElement('input');
                    panToNode.setAttribute("type", "button");
                    panToNode.value = `goto pad 0x${id.toString(16)}`;
                    panToNode.dataset.xPadId = id;
                    panToNode.onclick = HandleDialogClickPanToPad;
                    div.appendChild(panToNode);
                }

                if (node.dataset.xChrId) {
                    let id = parseInt(node.dataset.xChrId);

                    let target = svg.querySelectorAll(`#svg-setup-chr-layer #svg-setup-chr-${id}`);

                    if (!target || target.length < 1) {
                        let msgNode = document.createElement('div');
                        msgNode.innerHTML = `LATE SPAWN: chr 0x${id.toString(16)}`;
                        div.appendChild(msgNode);
                    } else {
                        let panToNode = document.createElement('input');
                        panToNode.setAttribute("type", "button");
                        panToNode.value = `goto chr 0x${id.toString(16)}`;
                        panToNode.dataset.xChrId = id;
                        panToNode.onclick = HandleDialogClickPanToChr;
                        div.appendChild(panToNode);
                    }
                }

                dialogContent.appendChild(div);
            }
        }

        function HandleDialogClickPanToPad(e) {
            let node = this;

            let id = parseInt(node.dataset.xPadId);

            let svg = GetSvg();
            if (!svg) {
                return;
            }

            let target = svg.querySelectorAll(`#svg-pad-layer #svg-pad-${id}`)[0];

            SvgUnselectSecondary();
            SpzPanToItem(target);
            SpzNodeAddReClass(target, "secondary");
        }

        function HandleDialogClickPanToChr(e) {
            let node = this;

            let id = parseInt(node.dataset.xChrId);

            let svg = GetSvg();
            if (!svg) {
                return;
            }

            let target = svg.querySelectorAll(`#svg-setup-chr-layer #svg-setup-chr-${id}`)[0];

            SvgUnselectSecondary();
            SpzPanToItem(target);
            SpzNodeAddReClass(target, "secondary");
        }

        function DialogSetTitlebar(text) {
            let dialogTitlebar = document.getElementById('dialog').querySelectorAll('.titletext')[0];
            dialogTitlebar.innerHTML = text;
        }

        function HandleMaybeSelectItem(e) {
            if (!g_AllowDialog) {
                return false;
            }

            let xml = document.getElementById('mmap').contentDocument;
            if (!xml) {
                return false;
            }

            const x = e.clientX;
            const y = e.clientY;

            let items = xml.elementsFromPoint(x, y);
            if (!items || items.length < 1) {
                return false;
            }

            for (let item of items) {
                let node = item;
                if (!item.classList.contains('svg-logical-item')) {
                    node = item.closest('.svg-logical-item');
                    if (!node || node.tagName == "svg") {
                        continue;
                    }
                }

                if (!EnsureNodeTypedef(node)) {
                    continue;
                }

                if (node == g_SelectedItem) {
                    return true;
                }

                if (node.dataset.display === 'Guard'
                    || node.dataset.display === 'Pad')
                {
                    SvgUnselectItems();
                    DialogSelectItem(node);
                    g_SelectedItem = node;
                    node.classList.add("selected");
                    return true;
                }
            }

            return false;
        }

        // entry for click in annotation node.
        function HandleMaybeClickAnnotation(e) {
            if (g_AnnotateState == 0) {
                return false;
            } else if (g_AnnotateState == 10 || g_AnnotateState == 11) {
                return HandleAnnotateClickGuardAimLimit(e);
            } else if (g_AnnotateState == 20 || g_AnnotateState == 21) {
                return HandleAnnotateClickCircle(e);
            } else if (g_AnnotateState == 30) {
                return HandleAnnotateClickNoise(e);
            } else if (g_AnnotateState == 99) {
                return HandleAnnotateClickErase(e);
            } else {
                return false;
            }
        }

        function HandleAnnotateClickGuardAimLimit(e) {

            let mouse = MouseToScaledCoord(e);

            if (g_AnnotateState == 10) {
                // currently ghost button cursor, this click event needs to add the origin point
                // and add ghost line

                g_AnnotatePrevClick = mouse;

                g_AnnotateState = 11;
                return true;
            } else if (g_AnnotateState == 11) {
                // currently in ghost line mode, need to remove ghost line, remove origin point,
                // and place aim limit with correct rotation.

                let angle = Math.atan2(g_AnnotatePrevClick.y - mouse.y, mouse.x - g_AnnotatePrevClick.x);
                DrawGuardAimLimit({ x: g_AnnotatePrevClick.x, y: g_AnnotatePrevClick.y, angle: angle });

                ResetAnnotateState();
                return true;
            }
        }

        function HandleAnnotateClickCircle(e) {
            ResetAnnotateState();
            return true;
        }

        function HandleAnnotateClickNoise(e) {
            ResetAnnotateState();
            return true;
        }

        function HandleAnnotateClickErase(e) {

            let xml = document.getElementById('mmap').contentDocument;
            if (!xml) {
                return false;
            }

            const x = e.clientX;
            const y = e.clientY;

            let items = xml.elementsFromPoint(x, y);
            if (!items || items.length < 1) {
                return false;
            }

            for (let item of items) {
                let node = item;
                if (!item.classList.contains('logical-annotation')) {
                    node = item.closest('.logical-annotation');
                    if (!node || node.tagName == "svg") {
                        continue;
                    }

                    node.remove();
                    ResetAnnotateState();

                    return true;
                }
            }

            return false;
        }

        function HandleButtonAimLimit(e) {
            if (g_UseMode != UseMode.Annotate) {
                return;
            }
            if (!g_ZoomerLoaded) {
                return;
            }
            if (g_AnnotateState != 0) {
                return;
            }

            g_AnnotateState = 10;
            UiAnnotateDisableOtherButtons(e.target.closest('[onclick]'));
        }
        function HandleButtonCircle(e) {
            if (g_UseMode != UseMode.Annotate) {
                return;
            }
            if (!g_ZoomerLoaded) {
                return;
            }
            if (g_AnnotateState != 0) {
                return;
            }

            g_AnnotateState = 20;
            UiAnnotateDisableOtherButtons(e.target.closest('[onclick]'));
        }

        function HandleButtonErase1(e) {
            if (g_UseMode != UseMode.Annotate) {
                return;
            }
            if (!g_ZoomerLoaded) {
                return;
            }
            if (g_AnnotateState != 0) {
                return;
            }

            g_AnnotateState = 99;
            UiAnnotateDisableOtherButtons(e.target.closest('[onclick]'));
        }

        function HandleButtonEraseAll() {
            if (g_UseMode != UseMode.Annotate) {
                return;
            }
            if (!g_ZoomerLoaded) {
                return;
            }
            if (g_AnnotateState != 0) {
                return;
            }
        }

        function HandleButtonNoise(e) {
            if (g_UseMode != UseMode.Annotate) {
                return;
            }
            if (!g_ZoomerLoaded) {
                return;
            }
            if (g_AnnotateState != 0) {
                return;
            }

            g_AnnotateState = 30;
            UiAnnotateDisableOtherButtons(e.target.closest('[onclick]'));
        }

        function ResetAnnotateState() {
            g_AnnotateState = 0;

            Array.from(document.getElementById('control-buttons-annotate').querySelectorAll('button')).forEach(x => {
                x.classList.remove("ann-state-disable");
            });
            Array.from(document.getElementById('control-buttons-annotate').querySelectorAll('input[type="button"]')).forEach(x => {
                x.classList.remove("ann-state-disable");
            });
        }

        function UiAnnotateDisableOtherButtons(self) {
            Array.from(document.getElementById('control-buttons-annotate').querySelectorAll('button')).forEach(x => {
                if (x == self) {
                    return;
                }
                x.classList.add("ann-state-disable");
            });
            Array.from(document.getElementById('control-buttons-annotate').querySelectorAll('input[type="button"]')).forEach(x => {
                if (x == self) {
                    return;
                }
                x.classList.add("ann-state-disable");
            });
        }

        function SpzSelectAndPanToSelectedItem() {
            SpzPanToItem(g_SelectedItem);
            SpzNodeAddReClass(g_SelectedItem, "selected");
        }

        function SpzPanToItem(node) {
            if (!node) {
                return;
            }

            if (!g_ZoomerLoaded) {
                return;
            }

            // init + error checking, don't actually need.
            let svg = GetSvg();
            if (!svg) {
                return;
            }

            if (!node.dataset.scX || !node.dataset.scY) {
                return;
            }

            let spz = svgPanZoom(document.getElementById('mmap'));

            let zoom = spz.getZoom();

            // try to adjust for rounding error
            if ((g_MinZoomToPan - zoom) > 0.01 ) {
                spz.zoom(g_MinZoomToPan);
            }

            let sizes = spz.getSizes();
            var areaWidth = parseInt(getComputedStyle(document.getElementById('mmap')).width);
            var areaHeight = parseInt(getComputedStyle(document.getElementById('mmap')).height);
            let x = (areaWidth / 2) - parseInt(node.dataset.scX) * sizes.realZoom;
            let y = (areaHeight / 2) - parseInt(node.dataset.scZ) * sizes.realZoom;
            spz.pan({ x: x, y: y });
        }

        function SpzNodeAddReClass(node, classname) {
            node.classList.remove(classname);
            // re-trigger border animation
            window.setTimeout(function () { node.classList.add(classname); }, 20);
        }

        function SvgUnselectItems() {
            SvgUnselectPrimary();
            SvgUnselectSecondary();
        }

        function SvgUnselectPrimary() {
            let svg = GetSvg();
            if (!svg) {
                return;
            }

            let svgSelected = svg.querySelectorAll('.selected');
            for (const node of svgSelected) {
                node.classList.remove("selected");
            }
        }

        function SvgUnselectSecondary() {
            let svg = GetSvg();
            if (!svg) {
                return;
            }

            let svgSecondary = svg.querySelectorAll('.secondary');
            for (const node of svgSecondary) {
                node.classList.remove("secondary");
            }
        }

        function DialogSelectItem(node) {
            if (!g_AllowDialog) {
                return;
            }

            if (!g_ZoomerLoaded) {
                return;
            }

            if (!EnsureNodeTypedef(node)) {
                return;
            }

            EnsureDialog();

            let dnode = document.getElementById('dialog-selected-item');
            dnode.innerHTML = "";

            let mouseover_log = GetNodeLogText(node);

            let infoNode = document.createElement('div');

            let baseTextNode = document.createElement('div');
            baseTextNode.innerHTML = mouseover_log;
            infoNode.appendChild(baseTextNode);

            let panToNodeParent = document.createElement('div');
            let panToNode = document.createElement('input');
            panToNode.setAttribute("type", "button");
            panToNode.value = "goto";
            panToNode.onclick = SpzSelectAndPanToSelectedItem;
            panToNodeParent.appendChild(panToNode);
            infoNode.appendChild(panToNodeParent);

            if (node.dataset.xAiInit) {
                DialogAppendSeperator(infoNode);

                let aiInitNode = document.createElement('input');
                aiInitNode.setAttribute("type", "button");
                let id = parseInt(node.dataset.xAiInit);
                aiInitNode.value = `ai init: 0x${id.toString(16)}`;
                aiInitNode.dataset.xAiId = parseInt(id);
                aiInitNode.onclick = HandleDialogShowAiScript;
                infoNode.appendChild(aiInitNode);
            }

            if (node.dataset.xAiId) {
                DialogAppendSeperator(infoNode);

                let ids = SplitAttrTextArr(node.dataset.xAiId);

                for (let id of ids) {
                    id = parseInt(id);
                    let aiRefNode = document.createElement('input');
                    aiRefNode.setAttribute("type", "button");
                    aiRefNode.value = `ai ref: 0x${id.toString(16)}`;
                    aiRefNode.dataset.xAiId = parseInt(id);
                    aiRefNode.onclick = HandleDialogShowAiScript;
                    infoNode.appendChild(aiRefNode);
                }

            }

            dnode.dataset.selectedItemId = node.id;
            dnode.appendChild(infoNode);

            if (node.dataset.displayId) {
                let intId = parseInt(node.dataset.displayId);
                DialogSetTitlebar(`${node.dataset.display}: id=${intId} (0x${intId.toString(16)})`);
            } else {
                DialogSetTitlebar(`${node.dataset.display}`);
            }

            DialogClearAi();

            g_DialogBox.showDialog();
        }

        function HandleDialogShowAiScript(e) {
            if (!g_AllowDialog) {
                return;
            }

            var node = this;

            let id = parseInt(node.dataset.xAiId);
            DialogLoadAiScriptContent(id, true);
        }

        function DialogAppendSeperator(parent) {
            let sep = document.createElement('div');
            sep.classList.add('dialog-content-seperator');
            parent.appendChild(sep);
        }

        function SplitAttrTextArr(text) {
            if (!text || text.length < 2) {
                return [];
            }

            let wo = text.substr(1, text.length - 2);
            return wo.split(',').map(x => parseInt(x));
        }

        function DialogClearSelected() {
            let dnode = document.getElementById('dialog-selected-item');
            dnode.dataset.selectedItemId = "";
            dnode.innerHTML = "";
        }

        function DialogClearAi() {
            let dnode = document.getElementById('dialog-ailist');
            dnode.innerHTML = "";
        }

        function RebuildSlider() {

            let slider = document.getElementById('slider');
            if (!g_SliderInit) {
                g_SliderInit = true;
                noUiSlider.create(slider, {
                    start: [g_StageBounds.scaled.min.y, g_StageBounds.scaled.max.y],
                    connect: true,
                    range: {
                        'min': g_StageBounds.scaled.min.y,
                        'max': g_StageBounds.scaled.max.y
                    }
                });

                slider.noUiSlider.on('change.one', FilterVertivalSliderHandler);
            } else {
                newOptions = {
                    start: [g_StageBounds.scaled.min.y, g_StageBounds.scaled.max.y],
                    range: {
                        'min': g_StageBounds.scaled.min.y,
                        'max': g_StageBounds.scaled.max.y
                    }
                };
                slider.noUiSlider.updateOptions(
                    newOptions, // Object
                    true // Boolean 'fireSetEvent'
                );
            }

            document.getElementById('slider-left-y').value = g_StageBounds.scaled.min.y;
            document.getElementById('slider-right-y').value = g_StageBounds.scaled.max.y;
        }

        function ApplyManualBounds() {
            let slider_min = parseFloat(document.getElementById('slider-left-y').value);
            let slider_max = parseFloat(document.getElementById('slider-right-y').value);

            if (!isFinite(slider_min) || !isFinite(slider_max)) {
                return;
            }

            console.log('filter: min=' + slider_min + ', max=' + slider_max);

            FilterYCommon(slider_min, slider_max);

            document.getElementById('slider-left-y').value = slider_min;
            document.getElementById('slider-right-y').value = slider_max;
        }

        function FilterVertivalSliderHandler(values, handle, unencoded, tap, positions, noUiSlider) {

            let slider_min = parseFloat(values[0]);
            let slider_max = parseFloat(values[1]);

            console.log('filter: min=' + slider_min + ', max=' + slider_max);

            FilterYCommon(slider_min, slider_max);

            document.getElementById('slider-left-y').value = slider_min;
            document.getElementById('slider-right-y').value = slider_max;
        }

        function FilterYCommon(lower, upper) {
            let xml = document.getElementById('mmap').contentDocument;
            if (!xml) {
                return;
            }

            // undo previous vertical filtering
            Array.from(xml.querySelectorAll('[data-sc-y]')).forEach(x => x.classList.remove('vertical-bound-filter'));
            Array.from(xml.querySelectorAll('[data-s-min-y]')).forEach(x => x.classList.remove('vertical-bound-filter'));

            Array.from(xml.querySelectorAll('[data-sc-y]:not(svg)')).filter(x => Number(x.dataset.scY) < lower || Number(x.dataset.scY) > upper).forEach(x => x.classList.add('vertical-bound-filter'));
            Array.from(xml.querySelectorAll('[data-s-min-y]:not(svg)')).filter(x => Number(x.dataset.sMinY) < lower || Number(x.dataset.sMaxY) > upper).forEach(x => x.classList.add('vertical-bound-filter'));
        }

        function MapMouseEvent(e) {
            let xml = document.getElementById('mmap').contentDocument;
            if (!xml) {
                return;
            }

            LogMouseCoord(e);

            const x = e.clientX;
            const y = e.clientY;

            let items = xml.elementsFromPoint(x, y);
            if (!items || items.length < 1) {
                return;
            }

            let logStatusBar = false;

            //console.log('MapMouseEvent');

            for (let item of items) {
                let node = item;
                if (!item.classList.contains('svg-logical-item')) {
                    node = item.closest('.svg-logical-item');
                    if (!node || node.tagName == "svg") {
                        continue;
                    }
                }

                if (!logStatusBar) {
                    logStatusBar = true;
                    LogMouseOver(node);
                    break;
                }
                //console.log('mousemove: ' + node.id);
            }
        }

        function LogMouseCoord(e) {

            if (!g_ZoomerLoaded) {
                return;
            }

            let x = 1.0;
            let y = 1.0;

            //console.log(`mouse: ${e.clientX}, ${e.clientY}`);

            let p = MouseToScaledCoord(e);
            x = p.x;
            y = p.y;

            x = FloatToString(x, 3);
            y = FloatToString(y, 3);

            let mouseover_log = `pos: ${x}, ${y}`;

            document.getElementById('status-mouse-coord').innerHTML = mouseover_log;
        }

        function MouseToScaledCoord(e) {

            let svg = GetSvg();
            if (!svg) {
                return;
            }

            if (!g_SvgPoint) {
                return;
            }

            g_SvgPoint.x = e.clientX;
            g_SvgPoint.y = e.clientY;
            var svgpoint = g_SvgPoint.matrixTransform(svg.getScreenCTM().inverse());

            let spz = svgPanZoom(document.getElementById('mmap'));
            let pan = spz.getPan();

            let x = (svgpoint.x - pan.x) / spz.getSizes().realZoom;
            let y = (svgpoint.y - pan.y) / spz.getSizes().realZoom;

            return { x: x, y: y };
        }

        function EnsureNodeTypedef(node) {
            if (node.dataset.ig) {
                return false;
            }

            if (!node.dataset.typedef) {
                let nodetype = NodeIdStringToType(node.id);
                if (!nodetype) {
                    node.dataset.ig = 1;
                    return false;
                }
                node.dataset.typedef = nodetype['typemap']['type'];
                node.dataset.display = nodetype['typemap']['display'];

                if (node.dataset.display === 'Guard'
                    || node.dataset.display === 'Pad')
                {
                    node.dataset.displayId = nodetype["match"][1];
                }
            }

            return true;
        }

        function LogMouseOver(node) {

            if (!g_ZoomerLoaded) {
                return;
            }

            if (!EnsureNodeTypedef(node)) {
                return;
            }

            let mouseover_log = GetNodeLogText(node);

            if (g_UseMode == UseMode.Move) {
                document.getElementById('status-mouse-item').innerHTML = mouseover_log;
            } else if (g_UseMode == UseMode.Annotate) {
                document.getElementById('status-mouse-annotate').innerHTML = mouseover_log;
            }
        }

        // Assumes EnsureNodeTypedef was called prior to this function.
        function GetNodeLogText(node) {
            let mouseover_log = "";

            if (node.dataset.display === 'Patrol') {
                mouseover_log += `${node.dataset.display}: id=${node.dataset.patrolNodeId}`;
            } else if (node.dataset.displayId) {
                mouseover_log += `${node.dataset.display}: id=${node.dataset.displayId}`;
            } else {
                mouseover_log += `${node.dataset.display}: roomid=${node.dataset.roomId}`;
            }

            // scaled coord
            if (node.dataset.scX) {
                mouseover_log += ` (${node.dataset.scX}, ${node.dataset.scY}, ${node.dataset.scZ})`;
            }

            if (node.dataset.propName) {
                mouseover_log += ` ${node.dataset.propName}`;
            }

            if (node.dataset.display === 'Guard') {
                if (node.dataset.chrClone !== undefined) {
                    mouseover_log += ", CLONE";
                }
                if (node.dataset.chrInvincible !== undefined) {
                    mouseover_log += ", INVINCIBLE";
                }
                mouseover_log += `, hearing: ${node.dataset.chrHdist}`;
                mouseover_log += `, visibility: ${node.dataset.chrVdist}`;
            }

            return mouseover_log;
        }

        var ClassTypeMap = [
            /* need longer matches first */
            { "re": new RegExp("svg-setup-alarm-([0-9]+)"), 'id': 15, 'type': 'Getools.Lib.Game.Asset.SetupObject.SetupObjectAlarm', 'display': 'Alarm' },
            { "re": new RegExp("svg-setup-ammo-([0-9]+)"), 'id': 14, 'type': 'Getools.Lib.Game.Asset.SetupObject.SetupObjectAmmoBox', 'display': 'Ammo' },
            { "re": new RegExp("svg-setup-aircraft-([0-9]+)"), 'id': 13, 'type': 'Getools.Lib.Game.Asset.SetupObject.SetupObjectAircraft', 'display': 'Aircraft' },
            { "re": new RegExp("svg-setup-bodyarmor-([0-9]+)"), 'id': 12, 'type': 'Getools.Lib.Game.Asset.SetupObject.SetupObjectBodyArmor', 'display': 'Body Armor' },
            { "re": new RegExp("svg-setup-chr-([0-9]+)"), 'id': 11, 'type': 'Getools.Lib.Game.Asset.SetupObject.SetupObjectGuard', 'display': 'Guard' },
            { "re": new RegExp("svg-setup-cctv-([0-9]+)"), 'id': 10, 'type': 'Getools.Lib.Game.Asset.SetupObject.SetupObjectCctv', 'display': 'CCTV' },
            { "re": new RegExp("svg-setup-collectable-([0-9]+)"), 'id': 9, 'type': 'Getools.Lib.Game.Asset.SetupObject.SetupObjectCollectObject', 'display': 'Collect' },
            { "re": new RegExp("svg-setup-door-([0-9]+)"), 'id': 8, 'type': 'Getools.Lib.Game.Asset.SetupObject.SetupObjectDoor', 'display': 'Door' },
            { "re": new RegExp("svg-setup-drone-([0-9]+)"), 'id': 7, 'type': 'Getools.Lib.Game.Asset.SetupObject.SetupObjectDrone', 'display': 'Drone' },
            { "re": new RegExp("svg-setup-key-([0-9]+)"), 'id': 6, 'type': 'Getools.Lib.Game.Asset.SetupObject.SetupObjectKey', 'display': 'Key' },
            { "re": new RegExp("svg-setup-safe-([0-9]+)"), 'id': 5, 'type': 'Getools.Lib.Game.Asset.SetupObject.SetupObjectSafe', 'display': 'Safe' },
            { "re": new RegExp("svg-setup-singlemonitor-([0-9]+)"), 'id': 4, 'type': 'Getools.Lib.Game.Asset.SetupObject.SetupObjectSingleMonitor', 'display': 'SingleMonitor' },
            { "re": new RegExp("svg-setup-prop-([0-9]+)"), 'id': 3, 'type': 'Getools.Lib.Game.Asset.SetupObject.SetupObjectStandard', 'display': 'Prop' },
            { "re": new RegExp("svg-setup-tank-([0-9]+)"), 'id': 2, 'type': 'Getools.Lib.Game.Asset.SetupObject.SetupObjectTank', 'display': 'Tank' },
            { "re": new RegExp("svg-setup-intro-([0-9]+)"), 'id': 1, 'type': 'Getools.Lib.Game.Asset.Intro.IntroSpawn', 'display': 'Spawn' },

            { "re": new RegExp("svg-patrol-([0-9]+)"), 'id': 19, 'type': 'Getools.Lib.Game.Asset.Setup.PathSet', 'display': 'Patrol' },

            { "re": new RegExp("svg-room-([0-9]+)-tile-([0-9]+)"), 'id': 17, 'type': 'Getools.Lib.Game.Asset.Stan.StandTile', 'display': 'Tile' },
            { "re": new RegExp("svg-pad-([0-9]+)"), 'id': 16, 'type': 'Getools.Lib.Game.Asset.Setup.Pad', 'display': 'Pad' },
            { "re": new RegExp("svg-room-([0-9]+)"), 'id': 18, 'type': 'Getools.Lib.Game.Asset.Bg.Room', 'display': 'Room' },
        ];

        function NodeIdStringToType(id) {
            for (let ctm of ClassTypeMap) {
                let match = id.match(ctm.re);
                if (match) {
                    return {
                        "typemap": ctm,
                        "match": match
                    };
                }
            }
            return null;
        }

        function PanZoomIn() {
            if (!g_ZoomerLoaded) {
                return;
            }
            let spz = svgPanZoom(document.getElementById('mmap'));
            spz.zoomIn();
        }
        function PanZoomReset() {
            if (!g_ZoomerLoaded) {
                return;
            }
            let spz = svgPanZoom(document.getElementById('mmap'));
            spz.resetZoom();
            spz.center();
        }
        function PanZoomOut() {
            if (!g_ZoomerLoaded) {
                return;
            }
            let spz = svgPanZoom(document.getElementById('mmap'));
            spz.zoomOut();
        }

        function GetSvg() {
            if (!g_ZoomerLoaded) {
                return null;
            }

            let xml = document.getElementById('mmap').contentDocument;
            if (!xml) {
                return null;
            }

            let svg = xml.getElementsByTagName('svg');
            if (!svg || svg.length != 1) {
                return null;
            }

            return svg[0];
        }

        function SetControlMode(mode) {

            if (!(typeof mode === 'symbol')) {
                return;
            }

            g_UseMode = mode;

            UpdateUiForControlMode();
        }

        function UpdateUiForControlMode() {
            let btn = null;

            if (g_UseMode == UseMode.Ruler) {
                document.getElementById('control-buttons-ruler').style.display = '';
                document.getElementById('control-buttons-move').style.display = 'none';
                document.getElementById('control-buttons-annotate').style.display = 'none';

                document.getElementById('status-ruler-dist').style.display = '';
                document.getElementById('status-mouse-item').style.display = 'none';
                document.getElementById('status-mouse-annotate').style.display = 'none';

                btn = document.getElementById('mode-control-ruler').getElementsByTagName('button')[0];
                btn.style.opacity = 0.3;
                btn.disabled = true;

                btn = document.getElementById('mode-control-move').getElementsByTagName('button')[0];
                btn.style.opacity = 1;
                btn.disabled = false;

                btn = document.getElementById('mode-control-annotate').getElementsByTagName('button')[0];
                btn.style.opacity = 1;
                btn.disabled = false;

            } else if (g_UseMode == UseMode.Move) {
                document.getElementById('control-buttons-ruler').style.display = 'none';
                document.getElementById('control-buttons-move').style.display = '';
                document.getElementById('control-buttons-annotate').style.display = 'none';

                document.getElementById('status-ruler-dist').style.display = 'none';
                document.getElementById('status-mouse-item').style.display = '';
                document.getElementById('status-mouse-annotate').style.display = 'none';

                btn = document.getElementById('mode-control-ruler').getElementsByTagName('button')[0];
                btn.style.opacity = 1;
                btn.disabled = false;

                btn = document.getElementById('mode-control-move').getElementsByTagName('button')[0];
                btn.style.opacity = 0.3;
                btn.disabled = true;

                btn = document.getElementById('mode-control-annotate').getElementsByTagName('button')[0];
                btn.style.opacity = 1;
                btn.disabled = false;

            } else if (g_UseMode == UseMode.Annotate) {
                document.getElementById('control-buttons-ruler').style.display = 'none';
                document.getElementById('control-buttons-move').style.display = 'none';
                document.getElementById('control-buttons-annotate').style.display = '';

                document.getElementById('status-ruler-dist').style.display = 'none';
                document.getElementById('status-mouse-item').style.display = 'none';
                document.getElementById('status-mouse-annotate').style.display = '';

                btn = document.getElementById('mode-control-ruler').getElementsByTagName('button')[0];
                btn.style.opacity = 1;
                btn.disabled = false;

                btn = document.getElementById('mode-control-move').getElementsByTagName('button')[0];
                btn.style.opacity = 1;
                btn.disabled = false;

                btn = document.getElementById('mode-control-annotate').getElementsByTagName('button')[0];
                btn.style.opacity = 0.3;
                btn.disabled = true;

            }
        }

        /*** ruler code ****/

        function HandleRulerMouseMove(e) {
            if (!g_ZoomerLoaded) {
                return;
            }

            if (g_UseMode != UseMode.Ruler) {
                return;
            }

            if (g_RulerDropMode == 0) {
                return;
            }

            UiSetFakeMarkerToMouseEvent(e);

            if (g_RulerDropMode == 2) {
                let minfo = UiDrawFakeLineToMouseEvent(e);

                RulerUpdateStatusBar(g_TotalDistance, g_TotalDistance + minfo.r);
            }
        }

        function HandleSvgClick(e) {

            if (g_UseMode == UseMode.Move) {
                if (g_AllowDialog) {
                    HandleMaybeSelectItem(e);
                }
            } else if (g_UseMode == UseMode.Ruler) {
                HandleRulerClick(e);
            } else if (g_UseMode == UseMode.Annotate) {
                if (!HandleMaybeClickAnnotation(e)) {
                    if (g_AllowDialog) {
                        HandleMaybeSelectItem(e);
                    }
                }
            }
        }

        function HandleRulerClick(e) {
            if (!g_ZoomerLoaded) {
                return;
            }

            if (g_RulerDropMode == 0) {
                return;
            }

            //console.log(`click at: ${e.x}, ${e.y}`);

            let coords = UiAppendDotAtMouseEvent(e);

            if (g_RulerDropMode == 2) {

                let minfo = UiAppendLineToMouseEvent(e);

                g_TotalDistance += minfo.r;

                RulerUpdateStatusBar(g_TotalDistance, null);
            }

            g_PreviousPoint.x = coords.translated.x;
            g_PreviousPoint.y = coords.translated.y;

            if (g_RulerDropMode == 1) {
                g_RulerDropMode = 2;

                //document.getElementById('fake-line').style.display = '';
            }
        }
        function HandleButtonStart() {
            if (!g_ZoomerLoaded) {
                return;
            }

            if (g_RulerDropMode == 0) {

                let spz = svgPanZoom(document.getElementById('mmap'));
                spz.disablePan();
                spz.disableZoom();

                RemoveAllUserRulerNodes();

                g_TotalDistance = 0;
                g_RulerDropMode = 1;

                RulerUpdateStatusBar(0, null);
            }
        }
        function HandleButtonStop() {
            if (!g_ZoomerLoaded) {
                return;
            }

            let spz = svgPanZoom(document.getElementById('mmap'));
            spz.enablePan();
            spz.enableZoom();

            g_LastRulerDropMode = g_RulerDropMode;
            if (g_RulerDropMode > 0) {
                g_RulerDropMode = 0;
                UiHideFakeMarkers();
            }

            RulerUpdateStatusBar(g_TotalDistance, null);
        }
        function HandleButtonContinue() {
            if (!g_ZoomerLoaded) {
                return;
            }

            let spz = svgPanZoom(document.getElementById('mmap'));
            spz.disablePan();
            spz.disableZoom();

            if (g_LastRulerDropMode == 2) {
                g_RulerDropMode = 2;
            } else if (g_LastRulerDropMode == 1) {
                g_RulerDropMode = 1;
            }
        }
        function HandleButtonClear() {
            if (!g_ZoomerLoaded) {
                return;
            }

            g_TotalDistance = 0;
            g_RulerDropMode = 0;
            RemoveAllUserLineNodes();
            UiHideFakeMarkers();
            RulerUpdateStatusBar(0, null);
        }

        function UiHideFakeMarkers() {
            RemoveFakeDot();
            RemoveFakeLine();
        }
        function EnsureUserRulerContainer() {
            let svg = GetSvg();
            if (!svg) {
                return null;
            }

            let svgSpz = svg.getElementsByClassName('svg-pan-zoom_viewport');
            if (!svgSpz || svgSpz.length < 1) {
                return null;
            }

            svgSpz = svgSpz[0];

            let userRulerContainer = svgSpz.getElementsByClassName('user-ruler-container');

            if (!userRulerContainer || userRulerContainer.length < 1) {
                userRulerContainer = document.createElementNS(svgns, 'g');
                userRulerContainer.classList.add('user-ruler-container');
                svgSpz.appendChild(userRulerContainer);
            } else {
                userRulerContainer = userRulerContainer[0];
            }

            return userRulerContainer;
        }

        function EnsureFakeDot() {
            let userRulerContainer = EnsureUserRulerContainer();
            if (!userRulerContainer) {
                return null;
            }

            let fakeDot = userRulerContainer.getElementsByClassName('the-fake-dot');

            if (!fakeDot || fakeDot.length < 1) {
                fakeDot = document.createElementNS(svgns, 'circle');
                fakeDot.setAttributeNS(null, 'r', g_DotDiameter);
                fakeDot.classList.add('the-fake-dot');
                fakeDot.classList.add('user-line');
                fakeDot.setAttributeNS(null, 'style', 'fill: #00ffc3; stroke: #4580ff; stroke-width: 2px; opacity: 0.5;');
                userRulerContainer.appendChild(fakeDot);
            } else {
                fakeDot = fakeDot[0];
            }

            return fakeDot;
        }

        function RemoveFakeDot() {
            let userRulerContainer = EnsureUserRulerContainer();
            if (!userRulerContainer) {
                return null;
            }

            let fakeDot = userRulerContainer.getElementsByClassName('the-fake-dot');

            if (!fakeDot || fakeDot.length < 1) {
                return;
            } else {
                fakeDot = fakeDot[0];
                fakeDot.remove();
            }
        }

        function EnsureFakeLine() {
            let userRulerContainer = EnsureUserRulerContainer();
            if (!userRulerContainer) {
                return null;
            }

            let fakeLine = userRulerContainer.getElementsByClassName('the-fake-line');

            if (!fakeLine || fakeLine.length < 1) {
                fakeLine = document.createElementNS(svgns, 'line');
                fakeLine.setAttributeNS(null, 'x2', 0);
                fakeLine.setAttributeNS(null, 'y2', 0);
                fakeLine.setAttributeNS(null, 'stroke-dasharray', g_RulerLineDash);
                fakeLine.classList.add('the-fake-line');
                fakeLine.classList.add('user-line');
                fakeLine.setAttributeNS(null, 'style', `stroke: #000000; stroke-width: ${g_RulerLineThickness}; opacity: 0.5;`);
                userRulerContainer.appendChild(fakeLine);
            } else {
                fakeLine = fakeLine[0];
            }

            fakeLine.setAttributeNS(null, 'x1', g_PreviousPoint.x);
            fakeLine.setAttributeNS(null, 'y1', g_PreviousPoint.y);

            return fakeLine;
        }

        function RemoveFakeLine() {
            let userRulerContainer = EnsureUserRulerContainer();
            if (!userRulerContainer) {
                return null;
            }

            let fakeLine = userRulerContainer.getElementsByClassName('the-fake-line');

            if (!fakeLine || fakeLine.length < 1) {
                return;
            } else {
                fakeLine = fakeLine[0];
                fakeLine.remove();
            }
        }

        // assumes all objects exist already
        function GetTranslatedCoordUnchecked(e) {
            let svg = GetSvg();
            if (!svg) {
                return null;
            }

            g_SvgPoint.x = e.clientX;
            g_SvgPoint.y = e.clientY;
            var svgpoint = g_SvgPoint.matrixTransform(svg.getScreenCTM().inverse());

            let spz = svgPanZoom(document.getElementById('mmap'));
            let pan = spz.getPan();

            x = (svgpoint.x - pan.x) / spz.getSizes().realZoom;
            y = (svgpoint.y - pan.y) / spz.getSizes().realZoom;

            return { "x": x, "y": y };
        }

        function UiAppendDotAtMouseEvent(e) {
            let svg = GetSvg();
            if (!svg) {
                return;
            }

            let userRulerContainer = EnsureUserRulerContainer();

            let svgCoords = GetTranslatedCoordUnchecked(e);

            let circle = document.createElementNS(svgns, 'circle');
            circle.setAttributeNS(null, 'cx', svgCoords.x);
            circle.setAttributeNS(null, 'cy', svgCoords.y);
            circle.setAttributeNS(null, 'r', g_DotDiameter);
            circle.classList.add('user-line');
            circle.setAttributeNS(null, 'style', 'fill: #00ffc3; stroke: #4580ff; stroke-width: 2px;');
            userRulerContainer.appendChild(circle);

            return {
                "screen": {
                    "x": e.clientX,
                    "y": e.clientY
                },
                "translated": {
                    "x": svgCoords.x,
                    "y": svgCoords.y
                }
            }
        }

        function UiAppendLineToMouseEvent(e) {
            let results = {
                "angle": 0,
                "r": 0
            };

            let fakeLine = EnsureFakeLine();
            if (!fakeLine) {
                return;
            }

            //console.log("g_PreviousPoint at: " + g_PreviousPoint.x + ", " + g_PreviousPoint.y);

            let svgCoords = GetTranslatedCoordUnchecked(e);

            let xside = svgCoords.x - g_PreviousPoint.x;
            let yside = svgCoords.y - g_PreviousPoint.y;
            let r = Math.sqrt(xside * xside + yside * yside);

            let userRulerContainer = EnsureUserRulerContainer();

            let line = document.createElementNS(svgns, 'line');
            line.setAttributeNS(null, 'x1', g_PreviousPoint.x);
            line.setAttributeNS(null, 'y1', g_PreviousPoint.y);
            line.setAttributeNS(null, 'x2', svgCoords.x);
            line.setAttributeNS(null, 'y2', svgCoords.y);
            line.setAttributeNS(null, 'stroke-dasharray', g_RulerLineDash);
            line.classList.add('user-line');
            line.setAttributeNS(null, 'style', `stroke: #000000; stroke-width: ${g_RulerLineThickness}; `);
            userRulerContainer.appendChild(line);

            results.r = r;
            return results;
        }

        function UiSetFakeMarkerToMouseEvent(e) {
            let fakeDot = EnsureFakeDot();
            if (!fakeDot) {
                return;
            }

            let svgCoords = GetTranslatedCoordUnchecked(e);

            fakeDot.setAttributeNS(null, 'cx', svgCoords.x);
            fakeDot.setAttributeNS(null, 'cy', svgCoords.y);
        }
        function UiDrawFakeLineToMouseEvent(e) {
            let results = {
                "angle": 0,
                "r": 0
            };

            let fakeLine = EnsureFakeLine();
            if (!fakeLine) {
                return;
            }

            let svgCoords = GetTranslatedCoordUnchecked(e);

            let xside = svgCoords.x - g_PreviousPoint.x;
            let yside = svgCoords.y - g_PreviousPoint.y;
            let r = Math.sqrt(xside * xside + yside * yside);

            //let angle = Math.atan2(yside, xside);

            fakeLine.setAttributeNS(null, 'x2', svgCoords.x);
            fakeLine.setAttributeNS(null, 'y2', svgCoords.y);

            results.r = r;
            return results;
        }
        function RemoveAllUserRulerNodes() {
            let svg = GetSvg();
            if (!svg) {
                return;
            }

            let userRulerContainer = EnsureUserRulerContainer();

            RemoveFakeDot();

            let nodes = userRulerContainer.getElementsByClassName('user-line');
            while (nodes.length > 0) {
                for (const n of nodes) {
                    n.remove();
                }
                nodes = userRulerContainer.getElementsByClassName('user-line');
            }
        }
        function FloatToString(f, digits) {
            let str = "" + f;
            if (!str) {
                return "";
            }
            if (digits < 1) {
                return str;
            }
            let dec = str.indexOf(".");
            if (dec < 1) {
                return str;
            }
            let len = str.length;
            if (dec + 1 + digits >= len) {
                return str;
            }
            return str.substr(0, dec + 1 + digits);
        }
        function RulerUpdateStatusBar(dist, hoverDist) {
            let html = '';
            if (hoverDist === null) {
                var a = 9;
            }
            if (Number.isFinite(dist)) {
                html += `dist: ${FloatToString(dist, 3)}`;
            }
            if (Number.isFinite(hoverDist)) {
                html += ` (to ${FloatToString(hoverDist, 3)})`;
            }
            document.getElementById('status-ruler-dist').innerHTML = html;
        }

        //

        function EnsureAnnotationContainer() {
            let svg = GetSvg();
            if (!svg) {
                return null;
            }

            let svgSpz = svg.getElementsByClassName('svg-pan-zoom_viewport');
            if (!svgSpz || svgSpz.length < 1) {
                return null;
            }

            svgSpz = svgSpz[0];

            let annotationContainer = svgSpz.getElementsByClassName('annotation-container');

            if (!annotationContainer || annotationContainer.length < 1) {
                annotationContainer = document.createElementNS(svgns, 'g');
                annotationContainer.classList.add('annotation-container');
                svgSpz.appendChild(annotationContainer);
            } else {
                annotationContainer = annotationContainer[0];
            }

            return annotationContainer;
        }

        function BuildPieSlice(settings) {
            /*** https://www.codedrome.com/drawing-arcs-pie-slices-with-svg/ */
            let d = "";

            const firstCircumferenceX = settings.centreX + settings.radius * Math.cos(settings.startAngleRadians);
            const firstCircumferenceY = settings.centreY + settings.radius * Math.sin(settings.startAngleRadians);
            const secondCircumferenceX = settings.centreX + settings.radius * Math.cos(settings.startAngleRadians + settings.sweepAngleRadians);
            const secondCircumferenceY = settings.centreY + settings.radius * Math.sin(settings.startAngleRadians + settings.sweepAngleRadians);

            // move to centre
            d += "M" + settings.centreX + "," + settings.centreY + " ";
            // line to first edge
            d += "L" + firstCircumferenceX + "," + firstCircumferenceY + " ";
            // arc
            // Radius X, Radius Y, X Axis Rotation, Large Arc Flag, Sweep Flag, End X, End Y
            d += "A" + settings.radius + "," + settings.radius + " 0 0,1 " + secondCircumferenceX + "," + secondCircumferenceY + " ";
            // close path
            d += "Z";

            const arc = document.createElementNS("http://www.w3.org/2000/svg", "path");

            arc.setAttributeNS(null, "d", d);
            arc.setAttributeNS(null, "fill", settings.fillColour);
            arc.setAttributeNS(null, "style", "stroke: #000000; stroke-width: 4px;");

            return arc;
        }

        function DrawGuardAimLimit(settings) {

            let ac = EnsureAnnotationContainer();

            let x = settings.x;
            let y = settings.y;

            const gnode = document.createElementNS("http://www.w3.org/2000/svg", "g");
            gnode.classList.add("logical-annotation");

            let deg = settings.angle * 180 / Math.PI;

            gnode.setAttributeNS(null, "style", `transform-origin: ${x}px ${y}px; transform: rotate(${deg}deg);`);

            gnode.dataset.scX = x;
            gnode.dataset.scY = y;

            let rad = 0;
            let arc = null;

            rad = Math.PI * 167.5 / 180;
            arc = BuildPieSlice({ centreX: x, centreY: y, radius: 2400, startAngleRadians: -rad / 2, sweepAngleRadians: rad, fillColour: "rgba(255, 255, 0, 0.3)" });
            gnode.appendChild(arc);

            rad = Math.PI * 83.5 / 180;
            arc = BuildPieSlice({ centreX: x, centreY: y, radius: 1600, startAngleRadians: -rad / 2, sweepAngleRadians: rad, fillColour: "rgba(255, 200, 0, 0.3)" });
            gnode.appendChild(arc);

            rad = Math.PI * 42.0 / 180;
            arc = BuildPieSlice({ centreX: x, centreY: y, radius: 800, startAngleRadians: -rad / 2, sweepAngleRadians: rad, fillColour: "rgba(255, 165, 0, 0.3)" });
            gnode.appendChild(arc);

            rad = Math.PI * 21.0 / 180;
            arc = BuildPieSlice({ centreX: x, centreY: y, radius: 400, startAngleRadians: -rad / 2, sweepAngleRadians: rad, fillColour: "rgba(255, 115, 0, 0.3)" });
            gnode.appendChild(arc);

            rad = Math.PI * 12.5 / 180;
            arc = BuildPieSlice({ centreX: x, centreY: y, radius: 200, startAngleRadians: -rad / 2, sweepAngleRadians: rad, fillColour: "rgba(255, 75, 0, 0.3)" });
            gnode.appendChild(arc);

            ac.appendChild(gnode);
        }

    </script>

    <div id="sidebar">
        <div id="column-left-head">
            <div class="big"><a href="/">Home</a></div>
            <div class="vert-space-24"></div>
            <div>Goldeneye map viewer (*beta)</div>
            <div class="vert-space-12"></div>
            <div><a href="https://github.com/burnsba/getools/tree/main/level">source</a></div>
            <div class="vert-space-12"></div>
            <div style="display: flex;">
                <input id="btn-hide-ui" type="button" value="hide <<" onclick="HideUiControls();" />
                <input id="btn-show-ui" type="button" value="show >>" onclick="ShowUiControls();" style="display: none;" />
                <div style="display: inline-block; padding-left: 6px;"><label><input type="checkbox" id="ui-panel-simple-mode-check" onchange="UiPanelToggleSimpleMode(this);" />Simple mode</label></div>
            </div>
        </div>

        <div id="column-left-body">
            <div class="col-left-sep"></div>

            <div id="control-panel">

                <div>
                    <div class="big">Stage</div>
                    <select id="level-select" onchange="ChangeLevel();">
                        <option value="" data-filename=""></option>
                        <option value="dam-u" data-filename="svgmap/u/Dam.svg">Dam</option>
                        <option value="facility-u" data-filename="svgmap/u/Facility.svg">Facility</option>
                        <option value="runway-u" data-filename="svgmap/u/Runway.svg">Runway</option>
                        <option value="surface1-u" data-filename="svgmap/u/Surface 1.svg">Surface 1</option>
                        <option value="bunker1-u" data-filename="svgmap/u/Bunker 1.svg">Bunker 1</option>
                        <option value="silo-u" data-filename="svgmap/u/Silo.svg">Silo (NTSC)</option>
                        <option value="silo-e" data-filename="svgmap/e/Silo.svg">Silo (PAL)</option>
                        <option value="silo-j" data-filename="svgmap/j/Silo.svg">Silo (NTSC-J)</option>
                        <option value="frigate-u" data-filename="svgmap/u/Frigate.svg">Frigate (NTSC)</option>
                        <option value="frigate-e" data-filename="svgmap/e/Frigate.svg">Frigate (PAL)</option>
                        <option value="frigate-j" data-filename="svgmap/j/Frigate.svg">Frigate (NTSC-J)</option>
                        <option value="surface2-u" data-filename="svgmap/u/Surface 2.svg">Surface 2</option>
                        <option value="bunker2-u" data-filename="svgmap/u/Bunker 2.svg">Bunker 2</option>
                        <option value="statue-u" data-filename="svgmap/u/Statue.svg">Statue (NTSC)</option>
                        <option value="statue-e" data-filename="svgmap/e/Statue.svg">Statue (PAL)</option>
                        <option value="statue-j" data-filename="svgmap/j/Statue.svg">Statue (NTSC-J)</option>
                        <option value="archives-u" data-filename="svgmap/u/Archives.svg">Archives</option>
                        <option value="streets-u" data-filename="svgmap/u/Streets.svg?v20230716094801">Streets (NTSC)</option>
                        <option value="streets-e" data-filename="svgmap/e/Streets.svg">Streets (PAL)</option>
                        <option value="depot-u" data-filename="svgmap/u/Depot.svg">Depot</option>
                        <option value="train-u" data-filename="svgmap/u/Train.svg">Train (NTSC)</option>
                        <option value="train-e" data-filename="svgmap/e/Train.svg">Train (PAL)</option>
                        <option value="train-j" data-filename="svgmap/j/Train.svg">Train (NTSC-J)</option>
                        <option value="jungle-u" data-filename="svgmap/u/Jungle.svg">Jungle (NTSC)</option>
                        <option value="jungle-e" data-filename="svgmap/e/Jungle.svg">Jungle (PAL)</option>
                        <option value="jungle-j" data-filename="svgmap/j/Jungle.svg">Jungle (NTSC-J)</option>
                        <option value="control-u" data-filename="svgmap/u/Control.svg">Control</option>
                        <option value="caverns-u" data-filename="svgmap/u/Caverns.svg">Caverns</option>
                        <option value="cradle-u" data-filename="svgmap/u/Cradle.svg">Cradle (NTSC)</option>
                        <option value="cradle-e" data-filename="svgmap/e/Cradle.svg">Cradle (PAL)</option>
                        <option value="cradle-j" data-filename="svgmap/j/Cradle.svg">Cradle (NTSC-J)</option>
                        <option value="aztec-u" data-filename="svgmap/u/Aztec.svg">Aztec</option>
                        <option value="egypt-u" data-filename="svgmap/u/Egypt.svg">Egypt</option>
                        <option value="citadel-u" data-filename="svgmap/u/Citadel.svg">Citadel</option>
                    </select>
                </div>

                <div class="vert-space-24"></div>

                <div id="control-layers-panel">
                    <div class="big">Layers</div>
                    <div>
                        <div class="s-row"><label><input type="checkbox" onchange="ToggleLayer(this);" name="check-bg-layer" checked />bg</label></div>
                        <div class="s-row"><label><input type="checkbox" onchange="ToggleLayer(this);" name="check-stan-layer" checked />stan</label></div>
                        <div class="s-row"><label><input type="checkbox" onchange="ToggleLayer(this);" name="check-setup-pad-layer" checked />setup: pad</label></div>
                        <div class="s-row"><label><input type="checkbox" onchange="ToggleLayer(this);" name="check-setup-waypoint-layer" checked />setup: path waypoint</label></div>
                        <div class="s-row"><label><input type="checkbox" onchange="ToggleLayer(this);" name="check-setup-patrol-layer" checked />setup: patrol path</label></div>
                        <div class="s-row"><label><input type="checkbox" onchange="ToggleLayer(this);" name="check-setup-alarm-layer" checked />setup: alarm</label></div>
                        <div class="s-row"><label><input type="checkbox" onchange="ToggleLayer(this);" name="check-setup-ammo-layer" checked />setup: ammo</label></div>
                        <div class="s-row"><label><input type="checkbox" onchange="ToggleLayer(this);" name="check-setup-aircraft-layer" checked />setup: aircraft</label></div>
                        <div class="s-row"><label><input type="checkbox" onchange="ToggleLayer(this);" name="check-setup-bodyarmor-layer" checked />setup: body armor</label></div>
                        <div class="s-row"><label><input type="checkbox" onchange="ToggleLayer(this);" name="check-setup-chr-layer" checked />setup: guard</label></div>
                        <div class="s-row"><label><input type="checkbox" onchange="ToggleLayer(this);" name="check-setup-cctv-layer" checked />setup: cctv</label></div>
                        <div class="s-row"><label><input type="checkbox" onchange="ToggleLayer(this);" name="check-setup-collectable-layer" checked />setup: collectable</label></div>
                        <div class="s-row"><label><input type="checkbox" onchange="ToggleLayer(this);" name="check-setup-door-layer" checked />setup: door</label></div>
                        <div class="s-row"><label><input type="checkbox" onchange="ToggleLayer(this);" name="check-setup-drone-layer" checked />setup: drone</label></div>
                        <div class="s-row"><label><input type="checkbox" onchange="ToggleLayer(this);" name="check-setup-key-layer" checked />setup: key</label></div>
                        <div class="s-row"><label><input type="checkbox" onchange="ToggleLayer(this);" name="check-setup-safe-layer" checked />setup: safe</label></div>
                        <div class="s-row"><label><input type="checkbox" onchange="ToggleLayer(this);" name="check-setup-singlemonitor-layer" checked />setup: single montior</label></div>
                        <div class="s-row"><label><input type="checkbox" onchange="ToggleLayer(this);" name="check-setup-prop-layer" checked />setup: standard prop</label></div>
                        <div class="s-row"><label><input type="checkbox" onchange="ToggleLayer(this);" name="check-setup-tank-layer" checked />setup: tank</label></div>
                        <div class="s-row"><label><input type="checkbox" onchange="ToggleLayer(this);" name="check-setup-intro-layer" checked />setup: intro (spawn)</label></div>
                    </div>

                </div>

                <div class="vert-space-24"></div>

                <div>
                    <div class="big">Vertical bounds</div>
                    <div>(scaled)</div>

                    <div>min: <input type="text" id="slider-left-y" /></div>
                    <div>max: <input type="text" id="slider-right-y" /></div>
                    <div><input type="button" value="apply" onclick="ApplyManualBounds();" /></div>
                    <div id="slider-container">
                        <div id="slider"></div>
                    </div>

                    <div>Stage min: <span id="map-min-y"></span></div>
                    <div>Stage max: <span id="map-max-y"></span></div>

                </div>

            </div>

            <div class="col-left-sep"></div>

            <div id="show-hide">
                <div class="big">Hide props</div>
                <div><input type="button" value="all" onclick="HideAllProps();"><div class="h-space-16"></div><input type="button" value="none" onclick="ShowAllProps();" /></div>
                <div id="show-hide-prop-inputs"></div>

                <div class="big">Hide patrols</div>
                <div><input type="button" value="all" onclick="HideAllPatrols();" /><div class="h-space-16"></div><input type="button" value="none" onclick="ShowAllPatrols();" /></div>
                <div id="show-hide-patrol-inputs"></div>
            </div>

            <div class="col-left-sep"></div>

            <div id="ai-scripts-panel">
                <div class="big">AI Scripts</div>
                <div id="list-ai-scripts"></div>
            </div>

            <div class="col-left-sep"></div>

            <div id="style-panel">
                <div class="big">Style</div>
                <div class="s-row"><label>stan outline color<input type="text" value="" data-selector=".gelib-stan" data-prop="stroke" data-css-type="color" onchange="ApplyStyleChange(this);" /></label></div>
                <div class="s-row"><label>stan outline width<input type="text" value="" data-selector=".gelib-stan" data-prop="stroke-width" data-css-type="number" onchange="ApplyStyleChange(this);" /></label></div>
                <div class="s-row"><label>stan fill color<input type="text" value="" data-selector=".gelib-stan" data-prop="fill" data-css-type="color" onchange="ApplyStyleChange(this);" /></label></div>
                <div class="s-row"><label>stan:hover outline color<input type="text" value="" data-selector=".gelib-stan:hover" data-prop="stroke" data-css-type="color" onchange="ApplyStyleChange(this);" /></label></div>
                <div class="s-row"><label>stan:hover outline width<input type="text" value="" data-selector=".gelib-stan:hover" data-prop="stroke-width" data-css-type="number" onchange="ApplyStyleChange(this);" /></label></div>
                <div class="s-row"><label>stan:hover fill color<input type="text" value="" data-selector=".gelib-stan:hover" data-prop="fill" data-css-type="color" onchange="ApplyStyleChange(this);" /></label></div>

                <div class="s-row"><label>room outline color<input type="text" value="" data-selector=".gelib-room" data-prop="stroke" data-css-type="color" onchange="ApplyStyleChange(this);" /></label></div>
                <div class="s-row"><label>room outline width<input type="text" value="" data-selector=".gelib-room" data-prop="stroke-width" data-css-type="number" onchange="ApplyStyleChange(this);" /></label></div>
                <div class="s-row"><label>room fill color<input type="text" value="" data-selector=".gelib-room" data-prop="fill" data-css-type="color" onchange="ApplyStyleChange(this);" /></label></div>
                <div class="s-row"><label>room fill opacity<input type="text" value="" data-selector=".gelib-room" data-prop="fill-opacity" data-css-type="number" onchange="ApplyStyleChange(this);" /></label></div>
                <div class="s-row"><label>room:hover outline color<input type="text" value="" data-selector=".gelib-room:hover" data-prop="stroke" data-css-type="color" onchange="ApplyStyleChange(this);" /></label></div>
                <div class="s-row"><label>room:hover outline width<input type="text" value="" data-selector=".gelib-room:hover" data-prop="stroke-width" data-css-type="number" onchange="ApplyStyleChange(this);" /></label></div>
                <div class="s-row"><label>room:hover fill color<input type="text" value="" data-selector=".gelib-room:hover" data-prop="fill" data-css-type="color" onchange="ApplyStyleChange(this);" /></label></div>

                <div class="s-row"><label>pad outline color<input type="text" value="" data-selector=".gelib-pad" data-prop="stroke" data-css-type="color" onchange="ApplyStyleChange(this);" /></label></div>
                <div class="s-row"><label>pad outline width<input type="text" value="" data-selector=".gelib-pad" data-prop="stroke-width" data-css-type="number" onchange="ApplyStyleChange(this);" /></label></div>
                <div class="s-row"><label>pad fill color<input type="text" value="" data-selector=".gelib-pad" data-prop="fill" data-css-type="color" onchange="ApplyStyleChange(this);" /></label></div>
                <div class="s-row"><label>pad:hover outline color<input type="text" value="" data-selector=".gelib-pad:hover" data-prop="stroke" data-css-type="color" onchange="ApplyStyleChange(this);" /></label></div>
                <div class="s-row"><label>pad:hover outline width<input type="text" value="" data-selector=".gelib-pad:hover" data-prop="stroke-width" data-css-type="number" onchange="ApplyStyleChange(this);" /></label></div>
                <div class="s-row"><label>pad:hover fill color<input type="text" value="" data-selector=".gelib-pad:hover" data-prop="fill" data-css-type="color" onchange="ApplyStyleChange(this);" /></label></div>

                <div class="s-row"><label>path waypoint color<input type="text" value="" data-selector=".gelib-wpline" data-prop="stroke" data-css-type="color" onchange="ApplyStyleChange(this);" /></label></div>
                <div class="s-row"><label>path waypoint:hover color<input type="text" value="" data-selector=".gelib-wpline:hover" data-prop="stroke" data-css-type="color" onchange="ApplyStyleChange(this);" /></label></div>

                <div class="s-row"><label>patrol path color<input type="text" value="" data-selector=".gelib-patrol" data-prop="stroke" data-css-type="color" onchange="ApplyStyleChange(this);" /></label></div>
                <div class="s-row"><label>patrol path:hover color<input type="text" value="" data-selector=".gelib-patrol:hover" data-prop="stroke" data-css-type="color" onchange="ApplyStyleChange(this);" /></label></div>
            </div>

            <div class="col-left-sep"></div>

            <div id="direct-download">
                <div class="big">Direct download svg:</div>
                <div class="s-row"><a href="svgmap/u/Dam.svg">Dam</a></div>
                <div class="s-row"><a href="svgmap/u/Facility.svg">Facility</a></div>
                <div class="s-row"><a href="svgmap/u/Runway.svg">Runway</a></div>
                <div class="s-row"><a href="svgmap/u/Surface 1.svg">Surface 1</a></div>
                <div class="s-row"><a href="svgmap/u/Bunker 1.svg">Bunker 1</a></div>
                <div class="s-row"><a href="svgmap/u/Silo.svg">Silo (NTSC)</a></div>
                <div class="s-row"><a href="svgmap/e/Silo.svg">Silo (PAL)</a></div>
                <div class="s-row"><a href="svgmap/j/Silo.svg">Silo (NTSC-J)</a></div>
                <div class="s-row"><a href="svgmap/u/Frigate.svg">Frigate (NTSC)</a></div>
                <div class="s-row"><a href="svgmap/e/Frigate.svg">Frigate (PAL)</a></div>
                <div class="s-row"><a href="svgmap/j/Frigate.svg">Frigate (NTSC-J)</a></div>
                <div class="s-row"><a href="svgmap/u/Surface 2.svg">Surface 2</a></div>
                <div class="s-row"><a href="svgmap/u/Bunker 2.svg">Bunker 2</a></div>
                <div class="s-row"><a href="svgmap/u/Statue.svg">Statue (NTSC)</a></div>
                <div class="s-row"><a href="svgmap/e/Statue.svg">Statue (PAL)</a></div>
                <div class="s-row"><a href="svgmap/j/Statue.svg">Statue (NTSC-J)</a></div>
                <div class="s-row"><a href="svgmap/u/Archives.svg">Archives</a></div>
                <div class="s-row"><a href="svgmap/u/Streets.svg">Streets (NTSC)</a></div>
                <div class="s-row"><a href="svgmap/e/Streets.svg">Streets (PAL)</a></div>
                <div class="s-row"><a href="svgmap/u/Depot.svg">Depot</a></div>
                <div class="s-row"><a href="svgmap/u/Train.svg">Train (NTSC)</a></div>
                <div class="s-row"><a href="svgmap/e/Train.svg">Train (PAL)</a></div>
                <div class="s-row"><a href="svgmap/j/Train.svg">Train (NTSC-J)</a></div>
                <div class="s-row"><a href="svgmap/u/Jungle.svg">Jungle (NTSC)</a></div>
                <div class="s-row"><a href="svgmap/e/Jungle.svg">Jungle (PAL)</a></div>
                <div class="s-row"><a href="svgmap/j/Jungle.svg">Jungle (NTSC-J)</a></div>
                <div class="s-row"><a href="svgmap/u/Control.svg">Control</a></div>
                <div class="s-row"><a href="svgmap/u/Caverns.svg">Caverns</a></div>
                <div class="s-row"><a href="svgmap/u/Cradle.svg">Cradle (NTSC)</a></div>
                <div class="s-row"><a href="svgmap/e/Cradle.svg">Cradle (PAL)</a></div>
                <div class="s-row"><a href="svgmap/j/Cradle.svg">Cradle (NTSC-J)</a></div>
                <div class="s-row"><a href="svgmap/u/Aztec.svg">Aztec</a></div>
                <div class="s-row"><a href="svgmap/u/Egypt.svg">Egypt</a></div>
                <div class="s-row"><a href="svgmap/u/Citadel.svg">Citadel</a></div>
            </div>

            <div class="vert-space-120"></div>
        </div>
    </div>

    <div id="map-area">
        <div style="display: flex; flex-direction: column;">
            <div id="map-container">

                <object id="mmap" data="" type="image/svg+xml">
                    <!-- <img src="yourfallback.jpg" /> -->
                </object>

                <div id="mode-controls">

                    <div>
                        <div id="mode-control-annotate" style="display: inline-block;">
                            <button onclick="SetControlMode(UseMode.Annotate);"><img src="img/pencil.png" title="annotate"/></button>
                        </div>
                        <div id="mode-control-ruler" style="display: inline-block;">
                            <button onclick="SetControlMode(UseMode.Ruler);"><img src="img/ruler.png" title="measure"/></button>
                        </div>
                        <div id="mode-control-move" style="display: inline-block;">
                            <button onclick="SetControlMode(UseMode.Move);" disabled><img src="img/move.png" title="move"/></button>
                        </div>
                    </div>

                    <div>
                        <div id="control-buttons-annotate" class="mode-control-panel" style="display: none;">
                            <div class="float-control-row">
                                <button class="m8" onclick="HandleButtonAimLimit(event);"><img src="img/aimlimit.png" title="guard aim limit"></button>
                                <button class="m8" onclick="HandleButtonCircle(event);"><img src="img/circle.png" title="circle"></button>
                                <div class="vstack m8" style="justify-content: center;">
                                    <input type="button" onclick="HandleButtonErase1(event);" value="erase x1">
                                    <div style="min-height: 8px;"></div>
                                    <input type="button" onclick="HandleButtonEraseAll(event);" value="erase all">
                                </div>
                            </div>
                            <div class="float-control-row">
                                <div class="m8" style="display: flex; flex-direction: column; border: 1px solid #cccccc; padding: 8px; background-color: #ffffff;">
                                    <div>
                                        <span class="ul">noise</span>
                                    </div>
                                    <div>
                                        <span>guard hearing</span>
                                        <input type="number" min="1" max="1000" value="1000">
                                        <select>
                                            <option value="1" data-min="0" data-max="1" data-step="1">Unarmed</option>
                                            <option value="1" data-min="0" data-max="1" data-step="1">Hunting Knife</option>
                                            <option value="1" data-min="0" data-max="1" data-step="1">Throwing Knife</option>
                                            <option value="12" data-min="1" data-max="12" data-step="2">PP7</option>
                                            <option value="5" data-min="0" data-max="5" data-step="1">PP7 (Silenced)</option>
                                            <option value="16" data-min="2" data-max="16" data-step="3">DD44</option>
                                            <option value="20" data-min="2" data-max="20" data-step="2">Klobb</option>
                                            <option value="20" data-min="2" data-max="20" data-step="2">KF7 Soviet</option>
                                            <option value="20" data-min="2" data-max="20" data-step="2">ZMG (9mm)</option>
                                            <option value="20" data-min="2" data-max="20" data-step="2">D5k</option>
                                            <option value="7" data-min="0" data-max="7" data-step="1.2">D5k (Silenced)</option>
                                            <option value="20" data-min="2" data-max="20" data-step="2">Phantom</option>
                                            <option value="20" data-min="2" data-max="20" data-step="2">Ar33</option>
                                            <option value="20" data-min="2" data-max="20" data-step="2">RC-P90</option>
                                            <option value="25" data-min="2" data-max="25" data-step="4">Shotgun</option>
                                            <option value="20" data-min="2" data-max="20" data-step="3">Auto Shotgun</option>
                                            <option value="7" data-min="0" data-max="7" data-step="1.2">Sniper Rifle</option>
                                            <option value="20" data-min="2" data-max="20" data-step="3">Cougar Magnum</option>
                                            <option value="9" data-min="1" data-max="9" data-step="1.5">Golden Gun</option>
                                            <option value="12" data-min="1" data-max="12" data-step="2">Silver PP7</option>
                                            <option value="12" data-min="1" data-max="12" data-step="2">Gold PP7</option>
                                            <option value="16" data-min="2" data-max="16" data-step="2">Laser</option>
                                            <option value="4" data-min="1" data-max="4" data-step="0.2">Watch Laser</option>
                                            <option value="20" data-min="2" data-max="20" data-step="2">Grenade Launcher</option>
                                            <option value="25" data-min="2" data-max="25" data-step="10">Rocket Launcher</option>
                                            <option value="2" data-min="0" data-max="2" data-step="2">Grenade</option>
                                            <option value="2" data-min="0" data-max="2" data-step="2">Timed Mine</option>
                                            <option value="2" data-min="0" data-max="2" data-step="2">Proximity Mine</option>
                                            <option value="2" data-min="0" data-max="2" data-step="2">Remote Mine</option>
                                            <option value="0" data-min="0" data-max="0" data-step="0">Detonator</option>
                                            <option value="10" data-min="2" data-max="10" data-step="2">Taser</option>
                                            <option value="25" data-min="2" data-max="25" data-step="10">Tank</option>
                                        </select>
                                        <input type="button" onclick="HandleButtonNoise(event);" value="add" />
                                    </div>
                                </div>
                            </div>
                            </div>
                        </div>

                        <div id="control-buttons-ruler" class="mode-control-panel" style="display: none;">
                            <div class="float-control-row"><input class="ctl-button" type="button" value="Start" onclick="HandleButtonStart();" /></div>
                            <div class="float-control-row"><input class="ctl-button" type="button" value="Stop" onclick="HandleButtonStop();" /></div>
                            <div class="float-control-row"><input class="ctl-button" type="button" value="Continue" onclick="HandleButtonContinue();" /></div>
                            <div class="float-control-row"><input class="ctl-button" type="button" value="Clear" onclick="HandleButtonClear();" /></div>
                        </div>

                        <div id="control-buttons-move" class="mode-control-panel">
                            <div class="float-control-row"><input class="ctl-button" type="button" id="control-zoom-in" onclick="PanZoomIn();" value="+" /></div>
                            <div class="float-control-row"><input class="ctl-button" type="button" id="control-reset" onclick="PanZoomReset();" value="reset" /></div>
                            <div class="float-control-row"><input class="ctl-button" type="button" id="control-zoom-out" onclick="PanZoomOut();" value="-" /></div>
                        </div>
                    </div>
                </div>

            </div>

            <div id="status-bar">
                <div id="status-mouse-coord"></div>
                <div id="status-ruler-dist" style="display: none;"></div>
                <div id="status-mouse-item"></div>
                <div id="status-mouse-annotate"></div>
            </div>
        </div>
    </div>

    <div id="dialog" class="dialog" style="min-width:400px; min-height:280px;">
        <div class="wrapper">
            <div class="titlebar">
                <div class="titletext big">Dialog Title...</div>
                <div><input class="close-button close-on-click big" type="button" value="X"></div>
            </div>
            <div class="content">
                <div id="dialog-selected-item"></div>
                <div id="dialog-ailist"></div>
            </div>
            <div class="buttonpane">
                <div class="buttonset">
                    <div><input type="button" onclick="DialogCheckSimpleMode();" value="Disable popup: simple mode" /></div>
                    <div><input class="close-on-click" type="button" value="Close"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            g_UseMode = UseMode.Move;
            UpdateUiForControlMode();

            EnsureDialog();

            document.getElementById('mmap').addEventListener('load', function () {
                UpdateControlPanel();
            });

            SetInitialControlValues();
        });

    </script>
</body>
</html>